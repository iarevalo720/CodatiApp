<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:UI.Converters"
             xmlns:viewmodel="clr-namespace:UI.ViewModels.Clientes"             
             x:Class="UI.Views.Clientes.C_misOrdenes"
             Title="Mis Órdenes">

    <ContentPage.Resources>
        <converters:ListToStringConverter x:Key="ListToStringConverter" />
    </ContentPage.Resources>

    <RefreshView IsRefreshing="{Binding EstaCargando}" 
                 Command="{Binding CargarMisOrdenes}">
        <ScrollView>
            <StackLayout Padding="20" Spacing="15" MaximumWidthRequest="900">

                <!-- Estado cuando no hay órdenes -->
                <StackLayout IsVisible="{Binding NoHayOrdenes}" 
                             HorizontalOptions="Center" 
                             VerticalOptions="Center"
                             Spacing="20">
                    <Image Source="no_orders.png" 
                           HeightRequest="120" 
                           WidthRequest="120" 
                           HorizontalOptions="Center"/>
                    <Label Text="No tienes órdenes registradas" 
                           FontSize="18" 
                           HorizontalOptions="Center" 
                           TextColor="{StaticResource Gray500}"/>
                    <Button Text="Actualizar" 
                            Command="{Binding CargarMisOrdenes}"
                            HorizontalOptions="Center"
                            WidthRequest="120"/>
                </StackLayout>

                <!-- Lista de órdenes -->
                <StackLayout IsVisible="{Binding HayOrdenes}" Spacing="10">
                    <Label Text="Mis Ordenes"
                           FontSize="20" 
                           FontAttributes="Bold" 
                           HorizontalOptions="Center" 
                           Margin="0,0,0,10"/>

                    <CollectionView ItemsSource="{Binding ListaOrdenes}" 
                                    SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame Padding="15" 
                                       CornerRadius="10" 
                                       BackgroundColor="#2a2a2a" 
                                       BorderColor="#555">
                                    <Grid RowDefinitions="auto,auto,auto,auto,auto" 
                                          ColumnDefinitions="auto,*"
                                          ColumnSpacing="10"
                                          RowSpacing="8">

                                        <!-- Número de orden y estado -->
                                        <Label Text="{Binding NroOrden, StringFormat='Orden #{0}'}" 
                                               FontSize="20" 
                                               FontAttributes="Bold" 
                                               Grid.Row="0" 
                                               Grid.Column="0"/>
                                        <Label Text="{Binding Estado}" 
                                               FontSize="20" 
                                               Grid.Row="0" 
                                               Grid.Column="1"
                                               VerticalOptions="Center"
                                               FontAttributes="Bold"
                                               TextColor="{Binding Estado, Converter={StaticResource EstadoColorConverter}}"/>

                                        <!-- Vehículo -->
                                        <Label Text="{Binding ResumenVehiculo}" 
                                               FontSize="14" 
                                               Grid.Row="1" 
                                               Grid.ColumnSpan="2"/>

                                        <!-- Fecha -->
                                        <Label Text="{Binding FechaCreacion, StringFormat='Fecha: {0}'}" 
                                               FontSize="12" 
                                               TextColor="Gray" 
                                               Grid.Row="2" 
                                               Grid.ColumnSpan="2"/>

                                        <!-- Servicios -->
                                        <Label Text="Servicios solicitados:" 
                                               FontSize="12" 
                                               FontAttributes="Bold" 
                                               Grid.Row="3" 
                                               Grid.Column="0"/>
                                        <Label Text="{Binding SubCategoria, Converter={StaticResource ListToStringConverter}}" 
                                               FontSize="12" 
                                               Grid.Row="3" 
                                               Grid.Column="1"
                                               HorizontalOptions="Start"
                                               LineBreakMode="WordWrap"/>

                                        <!-- Observación -->
                                        <StackLayout IsVisible="{Binding MensajeRechazo, Converter={StaticResource StringIsNotEmptyConverter}}"
                                                     Grid.Row="4" 
                                                     Grid.ColumnSpan="2">
                                            <Label Text="Motivo de rechazo:" 
                                                   FontSize="12" 
                                                   FontAttributes="Bold"/>
                                            <Label Text="{Binding MensajeRechazo}" 
                                                   FontSize="12" 
                                                   TextColor="Gray"
                                                   LineBreakMode="WordWrap"/>
                                        </StackLayout>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </StackLayout>
            </StackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>